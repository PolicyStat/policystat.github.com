
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>PolicyStat's Dev Blog: Pingdom and Intermittent Timeouts with mod_wsgi</title>
  <meta name="author" content="PolicyStat LLC">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link rel="canonical" href="http://devblog.policystat.com/intermittent-timeouts-with-modwsgi"/>
  <link href="/favicon.ico" rel="shortcut icon" />
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/policystatdevblog" rel="alternate" title="PolicyStat's Dev Blog" type="application/atom+xml"/>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-2228017-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

</head>

<body  >
  <header><hgroup>
  <h1><a href="/">PolicyStat's Dev Blog</a></h1>
  
</hgroup>

</header>
  <nav role=navigation><ul role=subscription data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/policystatdevblog" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="site-search">
    <input type="hidden" name="q" value="site:devblog.policystat.com/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About Us</a></li>
  <li><a href="http://www.policystat.com">PolicyStat Homepage</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry">
  
  <header>
    
      <h1 class="entry-title">Pingdom and Intermittent Timeouts With Mod_wsgi</h1>
    
    
      <p class="meta">




<time datetime="2010-12-17 15:07:00 -0500" pubdate  updated >Dec 17<span>th</span>, 2010</time>


</p>
    
  </header>


<div class="entry-content"><h2>Server Errors, but Only Sometimes</h2>
<p>We&#8217;ve been getting occasional reports from our users and staff that on rare occasions, a page doesn&#8217;t load. Of course, the descriptions varied from &#8220;server error&#8221; to &#8220;error page&#8221; to &#8220;page timeout&#8221; to &#8220;page hanging&#8221; but that&#8217;s the nature of verbal communication. English is hard, but debugging intermittent errors is probably harder. Luckily, we use <a href="http://pingdom.com/">Pingdom</a> to monitor our site and keep us informed of any problems, so we do have some data to refer to every time I hear of anyone having trouble. We run a check every minute against our login page to make sure that the welcome message and login form displays (among other checks). It&#8217;s been easy to just refer to that and be assured that we&#8217;ve actually had 100% uptime.</p>
<p><img src="/images/posts/intermittent-timeouts-with-modwsgi/uptime.png" alt="Pingdom Uptime" /></p>
<h2>100% Is Only Sorta 100%</h2>
<p>Looking back through the data again, I got a little bit suspicious. 100% seems too good to be true over 43,200 checks across the public internet, as you&#8217;d expect some packet somewhere to get dropped. After digging down to the detailed Pingdom report, I found out that Pingdom checks have another status beyond just &#8220;UP&#8221; or &#8220;DOWN.&#8221; If a check fails, another check follows it immediately to confirm, and the first failed check shows up in the detailed logs as &#8220;DOWN_UNCONFIRMED.&#8221; I comb through the logs and see that of the 43,200 checks in the last month, 47 of them have resulted in &#8220;DOWN_UNCONFIRMED&#8221; which is a bit more than 1 out of every 1000.</p>
<h2>mod_wsgi, I&#8217;m Doing It Wrong</h2>
<p>After combing through the various Nginx and Apache logs between all of our application servers, I find a rough pattern where around the time of a DOWN_UNCONFIRMED check I see one or more apache messages like this:</p>
<pre>[Tue Dec 14 12:11:04 2010] [error] [client xxx.xxx.xxx.xxx] Premature end of script headers: deploy.wsgi
</pre>
<p>Ah ha!</p>
<p>We use django running on mod_wsgi inside Apache2 reverse proxied via Nginx and deploy.wsgi is our Django wsgi file. Google helps me find a lot of different causes of the &#8220;Premature end of script headers&#8221; error message and I eliminate several of them. Finally I locate a post by the eminantly-helpful <a href="http://blog.dscpl.com.au/">Graham Dumpleton</a>&nbsp;on the <a href="http://groups.google.com/group/modwsgi/msg/480ea05b6e78f62e">mod_wsgi google group</a>&nbsp;where he mentions that whenever a <code>WSGIDaemonProcess</code>hits the <code>maximum-requests</code> limit, mod_wsgi will actually kill any requests currently being processed if they don&#8217;t finish within 5 seconds. Our intermittent hangs instantly made sense because we had a relatively aggressive maximum-requests value of 500 (a reminant of formerly running mysql, memcached and apache2/modwsgi all on the same server).</p>
<p>That meant that once every 500 requests, any users loading slow pages (reports, uploads, complex searches, etc) would get their request chopped off. It also explained why the failures were mostly clustered around our prime usage times because not only are page loads slightly slower when we&#8217;re under load, but the wsgi daemon processes will be getting more requests and thus restarting more frequently.</p>
<h2>Django + Apache2/mod_wsgi + Nginx Are Not Magic</h2>
<p>I&#8217;m a huge fan of mod_wsgi and how easy it is to administrate, but this just goes to show that even subtle configuration decisions can have an impact. Graham Dumpleton can&#8217;t read my mind, unfortunately.</p>
<p>Our solution was to increase the maximum-requests value to 10k. This should cut down the number of dropped requests by 20x. We&#8217;ve got quite a bit of extra RAM, so this seems like an easy fix.</p>
<p><img src="/images/posts/intermittent-timeouts-with-modwsgi/munin.png" alt="munin memory usage" /></p>
<p>We&#8217;ll also be monitoring memory usage using <a href="http://munin-monitoring.org/">Munin</a>&nbsp;and if it appears that memory leaks are not actually a problem for our application, we&#8217;ll consider upping the maximum-requests value even further. Perhaps we can even eliminate maximum-requests entirely in favor of using our normal alerting and monitoring system to notify us in case mod_wsgi memory usage hits an unacceptable threshold.</p>
<p>It seems that maybe the mod_wsgi documentation could benefit from a quick blurb about this side-effect of maximum-requests, so I opened a <a href="http://code.google.com/p/modwsgi/issues/detail?id=218">mod_wsgi issue</a> for a documentation enhancement.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Wes Winham</span></span>

      




<time datetime="2010-12-17 15:07:00 -0500" pubdate  updated >Dec 17<span>th</span>, 2010</time>



      

<span class="categories">
  
    <a class='category' href='/blog/categories/apache/'>apache</a>, <a class='category' href='/blog/categories/devops/'>devops</a>, <a class='category' href='/blog/categories/django/'>django</a>, <a class='category' href='/blog/categories/mod-wsgi/'>mod_wsgi</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://devblog.policystat.com/intermittent-timeouts-with-modwsgi" data-via="policystat" data-counturl="http://devblog.policystat.com/intermittent-timeouts-with-modwsgi" >Tweet</a>
  
  
  <g:plusone size="medium"></g:plusone>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread"><div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_developer = 0;
  if (document.domain != "http://devblog.policystat.com/") {
      disqus_developer = 1;
  }

  var disqus_shortname = 'policystatdevblog';
  var disqus_identifier = 'http://devblog.policystat.com/intermittent-timeouts-with-modwsgi';
  var disqus_url = 'http://devblog.policystat.com/intermittent-timeouts-with-modwsgi';
  //var disqus_developer = 1;
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside role=sidebar>
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/using-vim-as-your-git-mergetool/">Using Vim as Your Git Mergetool</a>
      </li>
    
      <li class="post">
        <a href="where-are-the-magic-deployment-tools">Where are the magic deployment tools?</a>
      </li>
    
      <li class="post">
        <a href="run-mysql-from-a-ram-disk-in-ubuntu">Run MySQL From a RAM Disk in Ubuntu Linux</a>
      </li>
    
      <li class="post">
        <a href="policypad-real-time-collaboration-through-you">PolicyPad: Etherpad + Bring Your Own Editor</a>
      </li>
    
      <li class="post">
        <a href="todays-amazon-ec2-ebs-outage-in-a-graph">Today&#8217;s Amazon ec2 EBS Outage in a Graph</a>
      </li>
    
  </ul>
</section>



  
</aside>


    </div>
  </div>
  <footer><p>
  Copyright &copy; 2011 - PolicyStat LLC -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
</body>
</html>
